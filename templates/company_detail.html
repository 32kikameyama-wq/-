{% extends base_template|default("layout.html") %}

{% set company_list_endpoint = company_list_endpoint if company_list_endpoint is defined else 'companies' %}
{% set project_detail_endpoint = project_detail_endpoint if project_detail_endpoint is defined else 'project_detail' %}
{% set company_list_url = back_url if back_url is defined else url_for(company_list_endpoint) %}
{% block title %}{{ company.name }} - æ¡ˆä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="content-wrapper">
    <section class="company-header-section">
        <div class="back-link">
            <a href="{{ company_list_url }}">â† ä¼šç¤¾ä¸€è¦§ã«æˆ»ã‚‹</a>
        </div>
        <h2>{{ company.name }}</h2>
        <div class="company-meta">
            <span class="company-code">{{ company.code }}</span>
            <span class="meta-item">æ¡ˆä»¶æ•°: {{ company.projects|length }}ä»¶</span>
        </div>
    </section>

    <section class="company-projects">
        <h3>æ¡ˆä»¶ä¸€è¦§</h3>
        <div class="projects-table-wrapper">
            <table class="projects-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-title">ä¼ç”»ã‚¿ã‚¤ãƒˆãƒ«</th>
                        <th class="col-axis">å‹•ç”»ç¨®é¡</th>
                        <th class="col-due">ç´æœŸ</th>
                        <th class="col-assignee">æ‹…å½“</th>
                        <th class="col-cl">CL</th>
                        <th class="col-material">å‹•ç”»ç´ æ</th>
                        <th class="col-final">å®Œæˆå‹•ç”»</th>
                        <th class="col-script">å°æœ¬</th>
                        <th class="col-delivery">ç´å“å®Œäº†æ—¥</th>
                        <th class="col-action">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in company.projects %}
                    <tr>
                        <td class="col-id">{{ project.id }}</td>
                        <td class="col-title">
                            <a href="{{ url_for(project_detail_endpoint, project_id=project.id) }}">{{ project.name }}</a>
                        </td>
                        <td class="col-axis">
                            <span class="axis-badge axis-{{ project.video_axis or 'LONG' }}">
                                {{ project.video_axis or 'LONG' }}
                            </span>
                        </td>
                        <td class="col-due">{{ project.due_date }}</td>
                        <td class="col-assignee">{{ project.assignee }}</td>
                        <td class="col-cl">
                            <label class="cl-checkbox-label">
                                <input type="checkbox" class="cl-checkbox" 
                                       data-project-id="{{ project.id }}" 
                                       {% if project.delivered %}checked{% endif %}
                                       onchange="toggleCL({{ project.id }}, this.checked)">
                                <span class="check-icon-display"></span>
                            </label>
                        </td>
                        <td class="col-material">
                            {% if project.raw_material_url %}
                            <a href="{{ project.raw_material_url }}" target="_blank" class="link-icon">ğŸ”—</a>
                            {% else %}
                            <span class="link-empty">-</span>
                            {% endif %}
                        </td>
                        <td class="col-final">
                            {% if project.final_video_url %}
                            <a href="{{ project.final_video_url }}" target="_blank" class="link-icon">ğŸ”—</a>
                            {% else %}
                            <span class="link-empty">-</span>
                            {% endif %}
                        </td>
                        <td class="col-script">
                            <span class="script-empty">-</span>
                        </td>
                        <td class="col-delivery">{{ project.delivery_date if project.delivery_date else '-' }}</td>
                        <td class="col-action">
                            <div class="action-buttons">
                                <a href="{{ url_for(project_detail_endpoint, project_id=project.id) }}" class="btn-link btn-link-small">è©³ç´°</a>
                                {% if allow_company_actions|default(True) %}
                                <button class="btn-link btn-link-small" onclick="editProject({{ project.id }})">ç·¨é›†</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if allow_company_actions|default(True) %}
        <div class="table-actions">
            <button class="btn btn-primary" onclick="addProject({{ company.id }})">æ–°è¦æ¡ˆä»¶ã‚’è¿½åŠ </button>
        </div>
        {% endif %}
    </section>
</div>

<script>
// ä¼šç¤¾ä¸€è¦§ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®šï¼ˆJavaScriptã§ä½¿ç”¨ï¼‰
window.companies = [{{ company|tojson }}];

// CLãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
function toggleCL(projectId, isChecked) {
    fetch(`/api/projects/${projectId}/toggle-delivered`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ delivered: isChecked })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            console.log('CLçŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            const checkbox = document.querySelector(`.cl-checkbox[data-project-id="${projectId}"]`);
            if (checkbox) {
                checkbox.checked = !isChecked;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('CLçŠ¶æ…‹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        const checkbox = document.querySelector(`.cl-checkbox[data-project-id="${projectId}"]`);
        if (checkbox) {
            checkbox.checked = !isChecked;
        }
    });
}

// æ¡ˆä»¶ç·¨é›†
function editProject(projectId) {
    fetch(`/api/projects/${projectId}`)
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                const project = result.data;
                showEditProjectForm(project);
            } else {
                alert('æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        });
}
</script>
{% endblock %}

