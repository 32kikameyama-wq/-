{% extends "layout.html" %}

{% block title %}請求・収支 - 案件管理システム{% endblock %}

{% block content %}
<div class="content-wrapper finance-page">
    <section class="finance-summary">
        <h2>収支サマリ</h2>
        <div class="finance-stats">
            <div class="finance-stat-card">
                <div class="finance-stat-label">総売上</div>
                <div class="finance-stat-value">¥{{ "{:,}".format(finance_data.total_revenue) }}</div>
            </div>
            <div class="finance-stat-card">
                <div class="finance-stat-label">総コスト</div>
                <div class="finance-stat-value">¥{{ "{:,}".format(finance_data.total_cost) }}</div>
            </div>
            <div class="finance-stat-card">
                <div class="finance-stat-label">粗利</div>
                <div class="finance-stat-value">¥{{ "{:,}".format(finance_data.profit) }}</div>
            </div>
            <div class="finance-stat-card">
                <div class="finance-stat-label">粗利率</div>
                <div class="finance-stat-value">{{ finance_data.profit_rate }}%</div>
            </div>
        </div>
    </section>

    <section class="finance-section">
        <details class="collapsible-card" open>
            <summary class="collapsible-summary">
                <div>
                    <h2>請求書一覧</h2>
                    <p class="summary-note">案件ごとの請求状況と入金ステータスを管理します。</p>
                </div>
                <div class="collapsible-actions">
                    <button type="button" class="btn btn-primary" id="addInvoiceBtn">請求書を追加</button>
                </div>
            </summary>
            <div class="collapsible-body">
                {% if finance_data.invoices %}
                <div class="finance-table">
                    <table class="finance-table-inner">
                        <thead>
                            <tr>
                                <th>案件名</th>
                                <th>金額</th>
                                <th>発行日</th>
                                <th>ステータス</th>
                                <th class="actions-col">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in finance_data.invoices %}
                            <tr class="finance-row"
                                data-type="invoice"
                                data-id="{{ invoice.id }}"
                                data-project-name="{{ invoice.project_name|replace('\n', '&#10;')|e }}"
                                data-amount="{{ invoice.amount }}"
                                data-issue-date="{{ invoice.issue_date }}"
                                data-status="{{ invoice.status }}">
                                <td>{{ invoice.project_name }}</td>
                                <td>¥{{ "{:,}".format(invoice.amount) }}</td>
                                <td>{{ invoice.issue_date or '---' }}</td>
                                <td><span class="status-badge status-{{ invoice.status }}">{{ invoice.status_label }}</span></td>
                                <td class="actions-col">
                                    <div class="table-actions">
                                        <button type="button" class="btn btn-outline btn-sm invoice-edit-btn">編集</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="finance-empty">請求書が登録されていません。右上のボタンから追加してください。</div>
                {% endif %}
            </div>
        </details>
    </section>

    <section class="finance-section">
        <details class="collapsible-card" open>
            <summary class="collapsible-summary">
                <div>
                    <h2>編集者支払一覧</h2>
                    <p class="summary-note">編集者ごとの支払予定・実績を管理します。</p>
                </div>
                <div class="collapsible-actions">
                    <button type="button" class="btn btn-primary" id="addPayoutBtn">支払を追加</button>
                </div>
            </summary>
            <div class="collapsible-body">
                {% if finance_data.payouts %}
                <div class="finance-table">
                    <table class="finance-table-inner">
                        <thead>
                            <tr>
                                <th>編集者</th>
                                <th>案件名</th>
                                <th>金額</th>
                                <th>ステータス</th>
                                <th class="actions-col">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payout in finance_data.payouts %}
                            <tr class="finance-row"
                                data-type="payout"
                                data-id="{{ payout.id }}"
                                data-editor="{{ payout.editor|replace('\n', '&#10;')|e }}"
                                data-project-name="{{ payout.project_name|replace('\n', '&#10;')|e }}"
                                data-amount="{{ payout.amount }}"
                                data-status="{{ payout.status }}">
                                <td>{{ payout.editor }}</td>
                                <td>{{ payout.project_name }}</td>
                                <td>¥{{ "{:,}".format(payout.amount) }}</td>
                                <td><span class="status-badge status-{{ payout.status }}">{{ payout.status_label }}</span></td>
                                <td class="actions-col">
                                    <div class="table-actions">
                                        <button type="button" class="btn btn-outline btn-sm payout-edit-btn">編集</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="finance-empty">編集者支払はまだ登録されていません。右上のボタンから追加してください。</div>
                {% endif %}
            </div>
        </details>
    </section>
</div>
{% endblock %}


{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/finance.js') }}" defer></script>

<div id="invoiceModal" class="gantt-modal finance-modal" aria-hidden="true" role="dialog" aria-labelledby="invoice-modal-title">
    <div class="modal-overlay" data-close-target="invoiceModal"></div>
    <div class="gantt-modal-content">
        <header class="gantt-modal-header">
            <h3 id="invoice-modal-title">請求書を追加</h3>
            <button type="button" class="gantt-modal-close" data-close-target="invoiceModal" aria-label="閉じる">×</button>
        </header>
        <div class="gantt-modal-body">
            <form id="invoiceForm" class="finance-form">
                <div class="form-group">
                    <label for="invoice_project_name">案件名 *</label>
                    <input type="text" id="invoice_project_name" name="project_name" required>
                </div>
                <div class="form-group">
                    <label for="invoice_amount">金額 (円) *</label>
                    <input type="number" id="invoice_amount" name="amount" min="0" placeholder="300000" required>
                </div>
                <div class="form-group">
                    <label for="invoice_issue_date">発行日</label>
                    <input type="date" id="invoice_issue_date" name="issue_date">
                </div>
                <div class="form-group">
                    <label for="invoice_status">ステータス</label>
                    <select id="invoice_status" name="status">
                        {% for status in invoice_status_options %}
                        <option value="{{ status.value }}">{{ status.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-actions">
                    <span id="invoiceFormMessage" class="form-message"></span>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-outline" data-close-target="invoiceModal">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存する</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="payoutModal" class="gantt-modal finance-modal" aria-hidden="true" role="dialog" aria-labelledby="payout-modal-title">
    <div class="modal-overlay" data-close-target="payoutModal"></div>
    <div class="gantt-modal-content">
        <header class="gantt-modal-header">
            <h3 id="payout-modal-title">支払情報を追加</h3>
            <button type="button" class="gantt-modal-close" data-close-target="payoutModal" aria-label="閉じる">×</button>
        </header>
        <div class="gantt-modal-body">
            <form id="payoutForm" class="finance-form">
                <div class="form-group">
                    <label for="payout_editor">編集者 *</label>
                    <input type="text" id="payout_editor" name="editor" required>
                </div>
                <div class="form-group">
                    <label for="payout_project_name">案件名 *</label>
                    <input type="text" id="payout_project_name" name="project_name" required>
                </div>
                <div class="form-group">
                    <label for="payout_amount">金額 (円) *</label>
                    <input type="number" id="payout_amount" name="amount" min="0" placeholder="120000" required>
                </div>
                <div class="form-group">
                    <label for="payout_status">ステータス</label>
                    <select id="payout_status" name="status">
                        {% for status in payout_status_options %}
                        <option value="{{ status.value }}">{{ status.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-actions">
                    <span id="payoutFormMessage" class="form-message"></span>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-outline" data-close-target="payoutModal">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存する</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}