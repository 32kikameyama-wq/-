{% extends base_template|default('layout.html') %}

{% block title %}ガントチャート | {{ super() }}{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
    window.GANTT_INITIAL_DATA = {{ initial_tasks|tojson }};
    window.GANTT_PROJECT_SUMMARY = {{ project_summary|default([], true)|tojson }};
    window.GANTT_SELECTED_FILTERS = {{ selected_filters|default({}, true)|tojson }};
    window.GANTT_PROJECT_CHOICES = {{ project_choices|default([], true)|tojson }};
    window.GANTT_DEPENDENCY_TYPES = {{ dependency_types|tojson }};
    window.GANTT_CURRENT_VIEW = {{ current_view|tojson }};
    window.GANTT_USER_ROLE = {{ current_user.role|tojson }};
</script>
<script src="{{ url_for('static', filename='js/gantt_view.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="page-header gantt-page-header">
    <div class="header-top">
        <div>
            <h1>ガントチャート</h1>
            <p class="page-subtitle">案件・タスクの計画と進捗を時間軸で可視化します</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" id="gantt-refresh-btn">
                更新
            </button>
        </div>
    </div>
</div>

<form class="gantt-filters" method="get">
    <div class="filter-row">
        <div class="filter-group">
            <label for="gantt-filter-project">案件</label>
            <select id="gantt-filter-project" class="filter-control" name="project_id">
                <option value="">すべて</option>
                {% for project in filter_options.projects %}
                <option value="{{ project.id }}" {% if selected_filters.project_id == project.id|string %}selected{% endif %}>{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="gantt-filter-assignee">担当者</label>
            <select id="gantt-filter-assignee" class="filter-control" name="assignee">
                <option value="">すべて</option>
                {% for assignee in filter_options.assignees %}
                <option value="{{ assignee }}" {% if selected_filters.assignee == assignee %}selected{% endif %}>{{ assignee }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="gantt-filter-status">ステータス</label>
            <select id="gantt-filter-status" class="filter-control" name="status">
                <option value="">すべて</option>
                {% for status in filter_options.statuses %}
                <option value="{{ status }}" {% if selected_filters.status == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="gantt-filter-keyword">キーワード</label>
            <input type="text" id="gantt-filter-keyword" class="filter-control" name="keyword" placeholder="案件名 / タスク名 / メモ" value="{{ selected_filters.keyword }}">
        </div>
        <div class="filter-group date-range">
            <label>期間</label>
            <div class="date-range-inputs">
                <input type="date" id="gantt-filter-start" class="filter-control" name="start_date" value="{{ selected_filters.start_date }}">
                <span class="date-range-separator">〜</span>
                <input type="date" id="gantt-filter-end" class="filter-control" name="end_date" value="{{ selected_filters.end_date }}">
            </div>
        </div>
        <div class="filter-group filter-actions">
            <button class="btn btn-outline" type="submit">絞り込む</button>
            <a class="btn btn-link" href="{{ url_for('admin_gantt') }}">リセット</a>
        </div>
    </div>
</form>

<div class="gantt-layout">
    <div class="gantt-main">
        <section class="gantt-summary-section">
            <header class="gantt-summary-header">
                <div class="summary-title">年間マイルストン概要</div>
                <div class="summary-legend">
                    <span class="legend-swatch auto"></span>自動生成フェーズ
                    <span class="legend-swatch manual"></span>手動追加タスク
                </div>
            </header>
            <div id="gantt-summary" class="gantt-summary"></div>
        </section>
        <section class="gantt-status-sheet">
            <header class="status-sheet-header">
                <div>
                    <h2 class="status-sheet-title">ステータス履歴シート</h2>
                    <p id="status-sheet-note" class="status-sheet-note">案件一覧で更新されたステータスの履歴を日単位で一覧表示します。絞り込み条件がそのまま反映されます。</p>
                </div>
            </header>
            <div id="gantt-status-sheet" class="status-sheet-table-wrapper"></div>
        </section>
        <div class="gantt-viewport">
            <div id="gantt-container" class="gantt-container" aria-label="Gantt chart timeline"></div>
            <div id="gantt-empty-state" class="gantt-empty-state" hidden>
                <p>条件に一致するタスクがありません。</p>
            </div>
        </div>
    </div>
    <aside class="gantt-side-panel" id="gantt-side-panel" aria-label="Task detail panel">
        <div class="side-panel-header">
            <div>
                <h2 id="gantt-task-title">タスク詳細</h2>
                <p id="gantt-task-project" class="task-project">案件: -</p>
            </div>
            <button class="side-panel-close" id="gantt-panel-close" aria-label="閉じる">×</button>
        </div>
        <div class="side-panel-content">
            <div class="side-panel-section">
                <h3>基本情報</h3>
                <div class="form-row">
                    <label for="gantt-detail-status">ステータス</label>
                    <select id="gantt-detail-status">
                        <option value="未着手">未着手</option>
                        <option value="進行中">進行中</option>
                        <option value="保留">保留</option>
                        <option value="レビュー中">レビュー中</option>
                        <option value="完了">完了</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="gantt-detail-progress">進捗（％）</label>
                    <input type="number" id="gantt-detail-progress" min="0" max="100" step="5">
                </div>
                <div class="form-row">
                    <label for="gantt-detail-assignee">担当者</label>
                    <input type="text" id="gantt-detail-assignee">
                </div>
                <div class="form-row">
                    <label for="gantt-detail-priority">優先度</label>
                    <select id="gantt-detail-priority">
                        <option value="高">高</option>
                        <option value="中">中</option>
                        <option value="低">低</option>
                    </select>
                </div>
            </div>

            <div class="side-panel-section">
                <h3>期間</h3>
                <div class="form-row">
                    <label for="gantt-plan-start">計画開始日</label>
                    <input type="date" id="gantt-plan-start">
                </div>
                <div class="form-row">
                    <label for="gantt-plan-end">計画終了日</label>
                    <input type="date" id="gantt-plan-end">
                </div>
                <div class="form-row">
                    <label for="gantt-actual-start">実績開始日</label>
                    <input type="date" id="gantt-actual-start">
                </div>
                <div class="form-row">
                    <label for="gantt-actual-end">実績終了日</label>
                    <input type="date" id="gantt-actual-end">
                </div>
            </div>

            <div class="side-panel-section">
                <h3>依存関係</h3>
                <div class="form-row">
                    <label for="gantt-dependencies">先行タスク</label>
                    <select id="gantt-dependencies" multiple size="5"></select>
                    <span class="form-text">※ Ctrl/⌘キーで複数選択</span>
                </div>
                <div class="form-row">
                    <label for="gantt-dependency-type">依存タイプ</label>
                    <select id="gantt-dependency-type">
                        {% for dep_type in dependency_types %}
                        <option value="{{ dep_type }}">{{ dep_type }}</option>
                        {% endfor %}
                    </select>
                    <span class="form-text">選択した先行タスクに適用します</span>
                </div>
                <div class="dependency-actions">
                    <button class="btn btn-outline" id="gantt-apply-dependency">追加/更新</button>
                    <button class="btn btn-link" id="gantt-clear-dependency">解除</button>
                </div>
                <ul class="dependency-list" id="gantt-dependency-list"></ul>
            </div>

            <div class="side-panel-section">
                <h3>並び順</h3>
                <div class="reorder-actions">
                    <button class="btn btn-outline" id="gantt-move-up">▲ 上へ</button>
                    <button class="btn btn-outline" id="gantt-move-down">▼ 下へ</button>
                </div>
            </div>

            <div class="side-panel-section">
                <h3>メモ</h3>
                <textarea id="gantt-detail-notes" rows="4" placeholder="メモ・課題・決定事項を記録"></textarea>
            </div>

            <div class="side-panel-section meta">
                <h3>メタ情報</h3>
                <p><span class="meta-label">作成者:</span> <span id="gantt-meta-created-by">-</span></p>
                <p><span class="meta-label">最終更新:</span> <span id="gantt-meta-updated">-</span></p>
            </div>
        </div>
        <div class="side-panel-footer">
            <button class="btn btn-outline" id="gantt-history-btn">履歴</button>
            <div class="side-panel-actions">
                <button class="btn btn-secondary" id="gantt-panel-cancel">キャンセル</button>
                <button class="btn btn-primary" id="gantt-panel-save">保存</button>
            </div>
        </div>
    </aside>
</div>

<div class="gantt-modal" id="gantt-history-modal" aria-hidden="true">
    <div class="modal-overlay" data-close-target="gantt-history-modal"></div>
    <div class="gantt-modal-content" role="dialog" aria-modal="true" aria-labelledby="gantt-history-title">
        <header class="gantt-modal-header">
            <h2 id="gantt-history-title">変更履歴</h2>
            <button class="gantt-modal-close" data-close-target="gantt-history-modal" aria-label="閉じる">×</button>
        </header>
        <div class="gantt-modal-body">
            <ul id="gantt-history-list" class="history-list"></ul>
        </div>
        <footer class="gantt-modal-footer">
            <button class="btn btn-secondary" data-close-target="gantt-history-modal">閉じる</button>
        </footer>
    </div>
</div>

<div class="gantt-modal" id="gantt-task-modal" aria-hidden="true">
    <div class="modal-overlay" data-close-target="gantt-task-modal"></div>
    <div class="gantt-modal-content large" role="dialog" aria-modal="true" aria-labelledby="gantt-task-modal-title">
        <header class="gantt-modal-header">
            <h2 id="gantt-task-modal-title">タスクを追加</h2>
            <button class="gantt-modal-close" data-close-target="gantt-task-modal" aria-label="閉じる">×</button>
        </header>
        <form id="gantt-task-form" class="gantt-task-form">
            <div class="gantt-modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-task-title">タスク名 *</label>
                        <input type="text" id="modal-task-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-task-project">案件 *</label>
                        <select id="modal-task-project" name="project_id" required></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-task-type">種別</label>
                        <select id="modal-task-type" name="type">
                            <option value="PLAN">PLAN</option>
                            <option value="EDIT">EDIT</option>
                            <option value="REVIEW">REVIEW</option>
                            <option value="DELIVERY">DELIVERY</option>
                            <option value="CAPTION">CAPTION</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-task-status">ステータス</label>
                        <select id="modal-task-status" name="status">
                            <option value="未着手">未着手</option>
                            <option value="進行中">進行中</option>
                            <option value="保留">保留</option>
                            <option value="レビュー中">レビュー中</option>
                            <option value="完了">完了</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-task-assignee">担当者</label>
                        <input type="text" id="modal-task-assignee" name="assignee">
                    </div>
                    <div class="form-group">
                        <label for="modal-task-priority">優先度</label>
                        <select id="modal-task-priority" name="priority">
                            <option value="高">高</option>
                            <option value="中" selected>中</option>
                            <option value="低">低</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-plan-start">計画開始</label>
                        <input type="date" id="modal-plan-start" name="plan_start">
                    </div>
                    <div class="form-group">
                        <label for="modal-plan-end">計画終了</label>
                        <input type="date" id="modal-plan-end" name="plan_end">
                    </div>
                    <div class="form-group">
                        <label for="modal-actual-start">実績開始</label>
                        <input type="date" id="modal-actual-start" name="actual_start">
                    </div>
                    <div class="form-group">
                        <label for="modal-actual-end">実績終了</label>
                        <input type="date" id="modal-actual-end" name="actual_end">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-task-progress">進捗（％）</label>
                        <input type="number" id="modal-task-progress" name="progress" min="0" max="100" step="5" value="0">
                    </div>
                    <div class="form-group">
                        <label for="modal-task-notes">メモ</label>
                        <textarea id="modal-task-notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <footer class="gantt-modal-footer">
                <button type="button" class="btn btn-secondary" data-close-target="gantt-task-modal">キャンセル</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </footer>
        </form>
    </div>
</div>
{% endblock %}

