<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}案件管理システム{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='js/project_form.js') }}" defer></script>
    {% block extra_scripts %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- 左サイドバー -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo">案件管理システム</h1>
                <div class="user-info">
                    {% if current_user %}
                    <div class="user-info-toggle" onclick="toggleUserMenu(this)">
                        <div class="user-info-primary">
                            <span class="user-name">{{ current_user.name }}</span>
                            {% if current_user_role_label %}
                            <span class="user-role">{{ current_user_role_label }}</span>
                            {% endif %}
                        </div>
                        <span class="user-toggle-icon">▼</span>
                    </div>
                    <ul class="user-menu" style="display: none;">
                        {% if current_user.role in ['admin', 'editor'] %}
                        <li class="user-menu-item">
                            <a href="{{ url_for('editor_dashboard') }}" class="user-menu-link {% if request.endpoint and request.endpoint.startswith('editor_') %}active{% endif %}">
                                <span class="user-menu-text">編集者ページ</span>
                            </a>
                        </li>
                        {% endif %}
                        <li class="user-menu-item">
                            <span class="user-menu-link disabled" title="準備中">
                                <span class="user-menu-text">クライアントページ</span>
                                <span class="user-menu-subtext">準備中</span>
                            </span>
                        </li>
                    </ul>
                    <div class="user-actions">
                        <form action="{{ url_for('logout') }}" method="post" class="user-menu-form">
                            <input type="hidden" name="next" value="{{ url_for('login') }}">
                            <button type="submit" class="logout-button">ログアウト</button>
                        </form>
                    </div>
                    {% else %}
                    <a href="{{ url_for('login') }}" class="user-menu-link user-menu-link-login">
                        <span class="user-menu-text">ログイン</span>
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/" class="nav-link {% if request.endpoint == 'index' %}active{% endif %}">
                            <span class="nav-text">トップ</span>
                        </a>
                    </li>
                    <li class="nav-item nav-item-with-submenu">
                        <div class="nav-link-with-toggle" onclick="toggleSubmenu(this)">
                            <span class="nav-text">案件管理</span>
                            <span class="nav-toggle-icon">▼</span>
                        </div>
                        <ul class="nav-submenu {% if request.endpoint in ['projects', 'project_detail', 'board', 'assets'] %}active{% endif %}" style="{% if request.endpoint in ['projects', 'project_detail', 'board', 'assets'] %}display: block;{% else %}display: none;{% endif %}">
                            <li class="nav-subitem">
                                <a href="/projects" class="nav-link {% if request.endpoint == 'projects' %}active{% endif %}">
                                    <span class="nav-text">案件一覧</span>
                                </a>
                            </li>
                            <li class="nav-subitem">
                                <a href="/board" class="nav-link {% if request.endpoint == 'board' %}active{% endif %}">
                                    <span class="nav-text">案件ボード</span>
                                </a>
                            </li>
                            <li class="nav-subitem">
                                <a href="/assets" class="nav-link {% if request.endpoint == 'assets' %}active{% endif %}">
                                    <span class="nav-text">素材管理</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="/companies" class="nav-link {% if request.endpoint in ['companies', 'company_detail'] %}active{% endif %}">
                            <span class="nav-text">会社一覧</span>
                        </a>
                    </li>
                    <li class="nav-item nav-item-with-submenu">
                        <div class="nav-link-with-toggle" onclick="toggleSubmenu(this)">
                            <span class="nav-text">タスク管理</span>
                            <span class="nav-toggle-icon">▼</span>
                        </div>
                        <ul class="nav-submenu {% if request.endpoint in ['task_dashboard', 'tasks'] %}active{% endif %}" style="{% if request.endpoint in ['task_dashboard', 'tasks'] %}display: block;{% else %}display: none;{% endif %}">
                            <li class="nav-subitem">
                                <a href="/tasks/dashboard" class="nav-link {% if request.endpoint == 'task_dashboard' %}active{% endif %}">
                                    <span class="nav-text">ダッシュボード</span>
                                </a>
                            </li>
                            <li class="nav-subitem">
                                <a href="/tasks" class="nav-link {% if request.endpoint == 'tasks' %}active{% endif %}">
                                    <span class="nav-text">タスク作成</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="/finance" class="nav-link {% if request.endpoint == 'finance' %}active{% endif %}">
                            <span class="nav-text">請求・収支</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/reports" class="nav-link {% if request.endpoint == 'reports' %}active{% endif %}">
                            <span class="nav-text">レポート</span>
                        </a>
                    </li>
                    {% if current_user and current_user.role == 'admin' %}
                    <li class="nav-item">
                        <a href="{{ url_for('admin_users') }}" class="nav-link {% if request.endpoint == 'admin_users' %}active{% endif %}">
                            <span class="nav-text">ユーザー管理</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('admin_training_videos') }}" class="nav-link {% if request.endpoint == 'admin_training_videos' %}active{% endif %}">
                            <span class="nav-text">インプット動画共有管理</span>
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a href="/settings" class="nav-link {% if request.endpoint == 'settings' %}active{% endif %}">
                            <span class="nav-text">設定</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <script>
            function toggleSubmenu(element) {
                event.preventDefault();
                event.stopPropagation();
                
                const submenu = element.nextElementSibling;
                const icon = element.querySelector('.nav-toggle-icon');
                
                if (submenu) {
                    const isActive = submenu.classList.contains('active');
                    
                    // すべてのサブメニューを閉じる
                    document.querySelectorAll('.nav-submenu').forEach(menu => {
                        menu.classList.remove('active');
                        menu.style.display = 'none';
                    });
                    
                    document.querySelectorAll('.nav-toggle-icon').forEach(toggleIcon => {
                        toggleIcon.textContent = '▼';
                    });
                    
                    // クリックしたサブメニューを開く/閉じる
                    if (!isActive) {
                        submenu.classList.add('active');
                        submenu.style.display = 'block';
                        if (icon) {
                            icon.textContent = '▲';
                        }
                    } else {
                        submenu.classList.remove('active');
                        submenu.style.display = 'none';
                        if (icon) {
                            icon.textContent = '▼';
                        }
                    }
                }
            }
            
            function toggleUserMenu(element) {
                event.preventDefault();
                event.stopPropagation();
                
                const userMenu = element.nextElementSibling;
                const icon = element.querySelector('.user-toggle-icon');
                
                if (userMenu) {
                    const isActive = userMenu.style.display === 'block';
                    
                    if (isActive) {
                        userMenu.style.display = 'none';
                        if (icon) {
                            icon.textContent = '▼';
                        }
                    } else {
                        userMenu.style.display = 'block';
                        if (icon) {
                            icon.textContent = '▲';
                        }
                    }
                }
            }
            
            // ページ読み込み時にアクティブなサブメニューを開く
            document.addEventListener('DOMContentLoaded', function() {
                const activeSubmenu = document.querySelector('.nav-submenu.active');
                if (activeSubmenu) {
                    activeSubmenu.style.display = 'block';
                    const toggleIcon = activeSubmenu.previousElementSibling.querySelector('.nav-toggle-icon');
                    if (toggleIcon) {
                        toggleIcon.textContent = '▲';
                    }
                } else {
                    // アクティブなサブメニューがない場合、すべて閉じる
                    document.querySelectorAll('.nav-submenu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }
            });
            </script>
        </aside>

        <!-- メインコンテンツエリア -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>
</body>
</html>

