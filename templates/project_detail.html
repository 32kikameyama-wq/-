{% extends base_template|default("layout.html") %}

{% set project_list_endpoint = project_list_endpoint if project_list_endpoint is defined else 'projects' %}
{% set back_to_list_url = back_url if back_url is defined else url_for(project_list_endpoint) %}
{% set company_detail_endpoint = company_detail_endpoint if company_detail_endpoint is defined else 'company_detail' %}
{% block title %}{{ project.name }} - 案件管理システム{% endblock %}

{% block content %}
<div class="content-wrapper">
    <section class="project-header-section">
        <div class="back-link">
            <a href="{{ back_to_list_url }}">← 案件一覧に戻る</a>
        </div>
        <h2>{{ project.name }}</h2>
        <div class="project-meta">
            <span class="status-badge status-{{ project.status }}">{{ project.status }}</span>
            {% if company %}
            <span class="meta-item">会社: <a href="{{ company_url if company_url is defined and company_url else url_for(company_detail_endpoint, company_id=company.id) }}">{{ company.name }}</a></span>
            {% else %}
            <span class="meta-item">会社: {{ project.client_name }}</span>
            {% endif %}
            <span class="meta-item">納期: {{ project.due_date }}</span>
            {% if project.assignee %}
            <span class="meta-item">動画担当: {{ project.assignee }}</span>
            {% endif %}
            {% if project.completion_length %}
            <span class="meta-item">完成尺: {{ project.completion_length }}分</span>
            {% endif %}
            {% if project.delivery_date %}
            <span class="meta-item">納品完了日: {{ project.delivery_date }}</span>
            {% endif %}
        </div>
        <div class="progress-bar-large">
            <div class="progress-fill" style="width: {{ project.progress }}%"></div>
            <span class="progress-text">{{ project.progress }}%</span>
        </div>
    </section>

    <!-- タブナビゲーション -->
    <section class="project-tabs">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('items')">アイテム</button>
            <button class="tab-button" onclick="showTab('tasks')">タスク</button>
            <button class="tab-button" onclick="showTab('assets')">素材</button>
            <button class="tab-button" onclick="showTab('comments')">コメント</button>
            <button class="tab-button" onclick="showTab('history')">履歴</button>
        </div>
    </section>

    <!-- アイテムタブ（LONG/SHORT） -->
    <section id="tab-items" class="tab-content active">
        <div class="items-header">
            <h3>動画アイテム（LONG/SHORT）</h3>
            {% if allow_project_actions|default(True) %}
            <button class="btn btn-small" onclick="addVideoItem()">アイテムを追加</button>
            {% endif %}
        </div>
        <div class="items-list">
            <div class="items-table">
                <table>
                    <thead>
                        <tr>
                            <th>軸</th>
                            <th>タイトル</th>
                            <th>ステータス</th>
                            <th>担当者</th>
                            <th>計画開始日</th>
                            <th>計画終了日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in video_items %}
                        <tr>
                            <td><span class="axis-badge axis-{{ item.axis }}">{{ item.axis }}</span></td>
                            <td>{{ item.title }}</td>
                            <td><span class="status-badge status-{{ item.status }}">{{ item.status }}</span></td>
                            <td>{{ item.assignee }}</td>
                            <td>{{ item.planned_start }}</td>
                            <td>{{ item.planned_end }}</td>
                            <td>
                                {% if allow_project_actions|default(True) %}
                                <a href="#" class="btn-link btn-link-small">編集</a>
                                {% else %}
                                <span class="btn-link-small disabled">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 未解決ブロッカー -->
        <div class="blockers-section">
            <h3>未解決ブロッカー</h3>
            {% if blockers %}
            <div class="blockers-list">
                {% for blocker in blockers %}
                <div class="blocker-item">
                    <span class="blocker-icon">⚠️</span>
                    <span class="blocker-text">{{ blocker.text }}</span>
                    <span class="blocker-date">{{ blocker.created_at }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-blockers">未解決のブロッカーはありません</p>
            {% endif %}
        </div>
    </section>

    <!-- タスクタブ -->
    <section id="tab-tasks" class="tab-content">
        <div class="tasks-header">
            <h3>タスク一覧</h3>
            {% if allow_project_actions|default(True) %}
            <button class="btn btn-small" onclick="addTask()">タスクを追加</button>
            {% endif %}
        </div>
        <div class="tasks-table">
            <table>
                <thead>
                    <tr>
                        <th>タスク名</th>
                        <th>タイプ</th>
                        <th>担当者</th>
                        <th>優先度</th>
                        <th>期限</th>
                        <th>ステータス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.title }}</td>
                        <td><span class="task-type">{{ task_type_labels.get(task.type, task.type) }}</span></td>
                        <td>{{ task.assignee }}</td>
                        <td>
                            <span class="priority-badge priority-{{ task.priority or '中' }}">
                                {{ task.priority or '中' }}
                            </span>
                        </td>
                        <td>{{ task.due_date }}</td>
                        <td><span class="status-badge status-{{ task.status }}">{{ task.status }}</span></td>
                        <td>
                            {% if allow_project_actions|default(True) %}
                            <a href="#" class="btn-link btn-link-small">編集</a>
                            {% else %}
                            <span class="btn-link-small disabled">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- 素材タブ -->
    <section id="tab-assets" class="tab-content">
        <div class="assets-header">
            <h3>素材・完成動画</h3>
            {% if allow_project_actions|default(True) %}
            <button class="btn btn-small" onclick="addAsset()">素材を追加</button>
            {% endif %}
        </div>
        <div class="assets-list">
            {% if project.raw_material_url %}
            <div class="asset-item">
                <h4>元素材</h4>
                <p><a href="{{ project.raw_material_url }}" target="_blank" class="asset-link">{{ project.raw_material_url }}</a></p>
            </div>
            {% endif %}
            {% if project.final_video_url %}
            <div class="asset-item">
                <h4>納品動画</h4>
                <p><a href="{{ project.final_video_url }}" target="_blank" class="asset-link">{{ project.final_video_url }}</a></p>
            </div>
            {% endif %}
            {% if assets %}
            <div class="assets-table">
                <table>
                    <thead>
                        <tr>
                            <th>ファイル名</th>
                            <th>種別</th>
                            <th>バージョン</th>
                            <th>アップロード者</th>
                            <th>アップロード日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in assets %}
                        <tr>
                            <td>{{ asset.name }}</td>
                            <td><span class="asset-kind">{{ asset.kind }}</span></td>
                            <td>v{{ asset.version }}</td>
                            <td>{{ asset.uploaded_by }}</td>
                            <td>{{ asset.uploaded_at }}</td>
                            <td>
                                {% if asset.url %}
                                <a href="{{ asset.url }}" target="_blank" class="btn-link btn-link-small">表示</a>
                                {% else %}
                                <span class="btn-link-small disabled">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            {% if not project.raw_material_url and not project.final_video_url and not assets %}
            <p>素材・完成動画のリンクはまだ登録されていません。</p>
            {% endif %}
        </div>
    </section>

    <!-- コメントタブ -->
    <section id="tab-comments" class="tab-content">
        <div class="comments-header">
            <h3>コメント</h3>
        </div>
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.author }}</span>
                    <span class="comment-date">{{ comment.created_at }}</span>
                </div>
                <div class="comment-content">{{ comment.content }}</div>
            </div>
            {% endfor %}
            {% if not comments %}
            <p>コメントはまだありません。</p>
            {% endif %}
        </div>
        {% if allow_project_actions|default(True) %}
        <div class="comment-form">
            <textarea id="comment-text" placeholder="コメントを入力してください"></textarea>
            <button class="btn btn-primary" onclick="addComment()">コメントを投稿</button>
        </div>
        {% endif %}
    </section>

    <!-- 履歴タブ -->
    <section id="tab-history" class="tab-content">
        <div class="history-header">
            <h3>履歴</h3>
        </div>
        <div class="history-list">
            {% for h in history %}
            <div class="history-item">
                <div class="history-action">{{ h.action }}</div>
                <div class="history-meta">
                    <span class="history-user">{{ h.user }}</span>
                    <span class="history-date">{{ h.timestamp }}</span>
                </div>
            </div>
            {% endfor %}
            {% if not history %}
            <p>履歴はまだありません。</p>
            {% endif %}
        </div>
    </section>
</div>

<script>
const PROJECT_ID = {{ project.id }};
const PROJECT_NAME = {{ project.name|tojson }};
const DEFAULT_ASSIGNEE = {{ project.assignee|tojson }};
const DEFAULT_DUE_DATE = {{ project.due_date|tojson }};

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

function closeDynamicModal(element) {
    const modal = element.closest('.project-form-modal');
    if (modal) {
        modal.remove();
    }
}

function addVideoItem() {
    const modal = document.createElement('div');
    modal.className = 'project-form-modal';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="closeDynamicModal(this)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>動画アイテムを追加</h3>
                    <button class="close-btn" onclick="closeDynamicModal(this)">×</button>
                </div>
                <form id="videoItemForm" class="project-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="video_title">タイトル *</label>
                            <input type="text" id="video_title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="video_axis">種類</label>
                            <select id="video_axis" name="axis">
                                <option value="LONG">LONG（長尺）</option>
                                <option value="SHORT">SHORT（ショート）</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="video_status">ステータス</label>
                            <select id="video_status" name="status">
                                <option value="計画中">計画中</option>
                                <option value="進行中" selected>進行中</option>
                                <option value="完了">完了</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="video_assignee">担当</label>
                            <input type="text" id="video_assignee" name="assignee" value="${DEFAULT_ASSIGNEE || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="planned_start">開始予定日</label>
                            <input type="date" id="planned_start" name="planned_start" value="${DEFAULT_DUE_DATE || ''}">
                        </div>
                        <div class="form-group">
                            <label for="planned_end">完了予定日</label>
                            <input type="date" id="planned_end" name="planned_end" value="${DEFAULT_DUE_DATE || ''}">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDynamicModal(this)">キャンセル</button>
                        <button type="submit" class="btn btn-primary">追加</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#videoItemForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const payload = {
            title: (formData.get('title') || '').trim(),
            axis: formData.get('axis'),
            status: formData.get('status'),
            assignee: formData.get('assignee'),
            planned_start: formData.get('planned_start'),
            planned_end: formData.get('planned_end')
        };
        if (!payload.title) {
            alert('タイトルを入力してください');
            return;
        }
        fetch(`/api/projects/${PROJECT_ID}/video-items`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                modal.remove();
                location.reload();
            } else {
                alert('エラー: ' + result.message);
            }
        })
        .catch(error => {
            console.error(error);
            alert('動画アイテムの追加中にエラーが発生しました');
        });
    });
}

function addTask() {
    const modal = document.createElement('div');
    modal.className = 'project-form-modal';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="closeDynamicModal(this)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>タスクを追加</h3>
                    <button class="close-btn" onclick="closeDynamicModal(this)">×</button>
                </div>
                <form id="taskForm" class="project-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task_title">タスク名 *</label>
                            <input type="text" id="task_title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="task_type">種別</label>
                            <select id="task_type" name="type">
                                <option value="EDIT">EDIT（編集）</option>
                                <option value="REVIEW">REVIEW（レビュー）</option>
                                <option value="DELIVERY">DELIVERY（納品）</option>
                                <option value="CAPTION">CAPTION（字幕）</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task_status">ステータス</label>
                            <select id="task_status" name="status">
                                <option value="未着手">未着手</option>
                                <option value="進行中" selected>進行中</option>
                                <option value="待機中">待機中</option>
                                <option value="完了">完了</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task_priority">優先度</label>
                            <select id="task_priority" name="priority">
                                <option value="高">高</option>
                                <option value="中" selected>中</option>
                                <option value="低">低</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task_assignee">担当</label>
                            <input type="text" id="task_assignee" name="assignee" value="${DEFAULT_ASSIGNEE || ''}">
                        </div>
                        <div class="form-group">
                            <label for="task_due_date">期限</label>
                            <input type="date" id="task_due_date" name="due_date" value="${DEFAULT_DUE_DATE || ''}">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDynamicModal(this)">キャンセル</button>
                        <button type="submit" class="btn btn-primary">追加</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#taskForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const title = (formData.get('title') || '').trim();
        if (!title) {
            alert('タスク名を入力してください');
            return;
        }
        const payload = {
            title,
            type: formData.get('type'),
            status: formData.get('status'),
            assignee: formData.get('assignee'),
            due_date: formData.get('due_date'),
            priority: formData.get('priority')
        };
        fetch(`/api/projects/${PROJECT_ID}/tasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                modal.remove();
                location.reload();
            } else {
                alert('エラー: ' + result.message);
            }
        })
        .catch(error => {
            console.error(error);
            alert('タスク追加中にエラーが発生しました');
        });
    });
}

function addAsset() {
    const modal = document.createElement('div');
    modal.className = 'project-form-modal';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="closeDynamicModal(this)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>素材を追加</h3>
                    <button class="close-btn" onclick="closeDynamicModal(this)">×</button>
                </div>
                <form id="assetForm" class="project-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="asset_name">ファイル名 *</label>
                            <input type="text" id="asset_name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="asset_kind">種別</label>
                            <select id="asset_kind" name="kind">
                                <option value="raw">素材</option>
                                <option value="final">完成版</option>
                                <option value="music">音源</option>
                                <option value="reference">参考資料</option>
                                <option value="other">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="asset_url">URL</label>
                            <input type="url" id="asset_url" name="url" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="asset_size">サイズ</label>
                            <input type="text" id="asset_size" name="size" placeholder="例: 120MB">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="asset_version">バージョン</label>
                            <input type="number" id="asset_version" name="version" value="1" min="1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDynamicModal(this)">キャンセル</button>
                        <button type="submit" class="btn btn-primary">追加</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#assetForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const name = (formData.get('name') || '').trim();
        if (!name) {
            alert('ファイル名を入力してください');
            return;
        }
        const payload = {
            name,
            kind: formData.get('kind'),
            url: formData.get('url'),
            size: formData.get('size'),
            version: parseInt(formData.get('version'), 10) || 1
        };
        fetch(`/api/projects/${PROJECT_ID}/assets`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                modal.remove();
                location.reload();
            } else {
                alert('エラー: ' + result.message);
            }
        })
        .catch(error => {
            console.error(error);
            alert('素材追加中にエラーが発生しました');
        });
    });
}

function addComment() {
    const textarea = document.getElementById('comment-text');
    const content = textarea.value.trim();
    if (!content) {
        alert('コメントを入力してください');
        return;
    }
    fetch(`/api/projects/${PROJECT_ID}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            textarea.value = '';
            location.reload();
        } else {
            alert('エラー: ' + result.message);
        }
    })
    .catch(error => {
        console.error(error);
        alert('コメント追加中にエラーが発生しました');
    });
}
</script>
{% endblock %}
