{% extends base_template|default("layout.html") %}

{% set detail_endpoint = project_detail_endpoint if project_detail_endpoint is defined else 'project_detail' %}
{% block title %}æ¡ˆä»¶ä¸€è¦§ - æ¡ˆä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="content-wrapper">
    <section class="projects-header">
        <div class="header-top">
            <div>
                <h2>æ¡ˆä»¶ä¸€è¦§</h2>
                <p class="subtitle">å…¨{{ projects|length }}ä»¶ã®æ¡ˆä»¶</p>
            </div>
            {% if allow_project_actions|default(True) %}
            <div class="header-actions">
                <button class="btn btn-primary" onclick="addCompany()">æ–°è¦ä¼šç¤¾ã‚’ç™»éŒ²</button>
            </div>
            {% endif %}
        </div>
        <div class="filter-section">
            <label for="company-filter" class="filter-label">ä¼šç¤¾ã§çµã‚Šè¾¼ã¿:</label>
            <select id="company-filter" class="company-filter" onchange="filterByCompany()">
                <option value="">ã™ã¹ã¦ã®ä¼šç¤¾</option>
                {% for company in companies %}
                <option value="{{ company.id }}" {% if request.args.get('company_id') == company.id|string %}selected{% endif %}>
                    {{ company.name }}
                </option>
                {% endfor %}
            </select>
            <span id="filtered-count" class="filtered-count"></span>
        </div>
    </section>

    <section class="projects-list">
        <div class="projects-table-wrapper">
            <table class="projects-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-company">ä¼šç¤¾</th>
                        <th class="col-title">ä¼ç”»ã‚¿ã‚¤ãƒˆãƒ«</th>
                        <th class="col-due">ç´æœŸ</th>
                        <th class="col-assignee">æ‹…å½“</th>
                        <th class="col-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th class="col-cl">CL</th>
                        <th class="col-material">å‹•ç”»ç´ æ</th>
                        <th class="col-final">å®Œæˆå‹•ç”»</th>
                        <th class="col-script">å°æœ¬</th>
                        <th class="col-delivery">ç´å“å®Œäº†æ—¥</th>
                        <th class="col-action">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr data-company-id="{{ project.company_id }}" data-project-id="{{ project.id }}">
                        <td class="col-id">{{ project.id }}</td>
                        <td class="col-company">{{ project.client_name }}</td>
                        <td class="col-title">
                            <a href="{{ url_for(detail_endpoint, project_id=project.id) }}">{{ project.name }}</a>
                        </td>
                        <td class="col-axis">
                            <span class="axis-badge axis-{{ project.video_axis or 'LONG' }}">
                                {{ project.video_axis or 'LONG' }}
                            </span>
                        </td>
                        <td class="col-due">{{ project.due_date }}</td>
                        <td class="col-assignee">{{ project.assignee }}</td>
                        <td class="col-status">
                            <select class="status-select" 
                                    data-project-id="{{ project.id }}"
                                    data-original-status="{{ project.status }}"
                                    onchange="updateStatus({{ project.id }}, this.value, this)">
                                <option value="è¨ˆç”»ä¸­" {% if project.status == 'è¨ˆç”»ä¸­' %}selected{% endif %}>è¨ˆç”»ä¸­</option>
                                <option value="é€²è¡Œä¸­" {% if project.status == 'é€²è¡Œä¸­' %}selected{% endif %}>é€²è¡Œä¸­</option>
                                <option value="ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­" {% if project.status == 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­' %}selected{% endif %}>ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­</option>
                                <option value="å®Œäº†" {% if project.status == 'å®Œäº†' %}selected{% endif %}>å®Œäº†</option>
                            </select>
                        </td>
                        <td class="col-cl">
                            <label class="cl-checkbox-label">
                                <input type="checkbox" class="cl-checkbox" 
                                       data-project-id="{{ project.id }}" 
                                       {% if project.delivered %}checked{% endif %}
                                       onchange="toggleCL({{ project.id }}, this.checked)">
                                <span class="check-icon-display"></span>
                            </label>
                        </td>
                        <td class="col-material">
                            {% if project.raw_material_url %}
                            <a href="{{ project.raw_material_url }}" target="_blank" class="link-icon">ğŸ”—</a>
                            {% else %}
                            <span class="link-empty">-</span>
                            {% endif %}
                        </td>
                        <td class="col-final">
                            {% if project.final_video_url %}
                            <a href="{{ project.final_video_url }}" target="_blank" class="link-icon">ğŸ”—</a>
                            {% else %}
                            <span class="link-empty">-</span>
                            {% endif %}
                        </td>
                        <td class="col-script">
                            <span class="script-empty">-</span>
                        </td>
                        <td class="col-delivery">{{ project.delivery_date if project.delivery_date else '-' }}</td>
                        <td class="col-action">
                            <div class="action-buttons">
                                <a href="{{ url_for(detail_endpoint, project_id=project.id) }}" class="btn-link btn-link-small">è©³ç´°</a>
                                {% if allow_project_actions|default(True) %}
                                <button class="btn-link btn-link-small" onclick="editProject({{ project.id }})">ç·¨é›†</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if allow_project_actions|default(True) %}
        <div class="table-actions">
            {% if request.args.get('company_id') %}
            <button class="btn btn-primary" onclick="addProject({{ request.args.get('company_id') }})">æ–°è¦æ¡ˆä»¶ã‚’è¿½åŠ </button>
            {% else %}
            <button class="btn btn-primary" onclick="addProject()">æ–°è¦æ¡ˆä»¶ã‚’è¿½åŠ </button>
            {% endif %}
        </div>
        {% endif %}
    </section>
</div>

<script>
// ä¼šç¤¾ä¸€è¦§ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®šï¼ˆJavaScriptã§ä½¿ç”¨ï¼‰
window.companies = {{ companies|tojson }};
function filterByCompany() {
    const companyId = document.getElementById('company-filter').value;
    const url = new URL(window.location);
    
    if (companyId) {
        url.searchParams.set('company_id', companyId);
    } else {
        url.searchParams.delete('company_id');
    }
    
    window.location.href = url.toString();
}

function updateFilteredCount() {
    const companyId = document.getElementById('company-filter').value;
    const table = document.querySelector('.projects-table tbody');
    if (table) {
        const rows = table.querySelectorAll('tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            if (companyId) {
                const rowCompanyId = row.getAttribute('data-company-id');
                if (rowCompanyId === companyId) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            } else {
                row.style.display = '';
                visibleCount++;
            }
        });
        
        const countElement = document.getElementById('filtered-count');
        if (companyId && countElement) {
            countElement.textContent = `ï¼ˆè¡¨ç¤º: ${visibleCount}ä»¶ï¼‰`;
        } else if (countElement) {
            countElement.textContent = '';
        }
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
document.addEventListener('DOMContentLoaded', function() {
    updateFilteredCount();
});

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
function updateStatus(projectId, newStatus, selectElement) {
    if (!selectElement) {
        selectElement = document.querySelector(`.status-select[data-project-id="${projectId}"]`);
    }
    if (!selectElement) {
        console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // å…ƒã®å€¤ã‚’ä¿å­˜ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã«æˆ»ã™ãŸã‚ï¼‰
    const originalStatus = selectElement.getAttribute('data-original-status');
    
    fetch(`/api/projects/${projectId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            // æˆåŠŸæ™‚ã¯å…ƒã®å€¤ã‚’æ›´æ–°
            selectElement.setAttribute('data-original-status', newStatus);
            console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å…ƒã®å€¤ã«æˆ»ã™
            selectElement.value = originalStatus;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å…ƒã®å€¤ã«æˆ»ã™
        selectElement.value = originalStatus;
    });
}

// CLãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
function toggleCL(projectId, isChecked) {
    fetch(`/api/projects/${projectId}/toggle-delivered`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ delivered: isChecked })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            // å®Œäº†æ—¥ã‚’ç”»é¢ã«åæ˜ 
            const row = document.querySelector(`tr[data-project-id="${projectId}"]`) || 
                       document.querySelector(`.cl-checkbox[data-project-id="${projectId}"]`)?.closest('tr');
            
            if (row) {
                const deliveryCell = row.querySelector('.col-delivery');
                if (deliveryCell) {
                    if (isChecked && result.data.delivery_date) {
                        deliveryCell.textContent = result.data.delivery_date;
                    } else {
                        deliveryCell.textContent = '-';
                    }
                }
            }
            
            console.log('CLçŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…ƒã«æˆ»ã™
            const checkbox = document.querySelector(`.cl-checkbox[data-project-id="${projectId}"]`);
            if (checkbox) {
                checkbox.checked = !isChecked;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('CLçŠ¶æ…‹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…ƒã«æˆ»ã™
        const checkbox = document.querySelector(`.cl-checkbox[data-project-id="${projectId}"]`);
        if (checkbox) {
            checkbox.checked = !isChecked;
        }
    });
}

// æ¡ˆä»¶ç·¨é›†
function editProject(projectId) {
    // æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    fetch(`/api/projects/${projectId}`)
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                const project = result.data;
                showEditProjectForm(project);
            } else {
                alert('æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        });
}
</script>
{% endblock %}


