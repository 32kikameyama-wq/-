{% extends "layout.html" %}

{% block title %}ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - æ¡ˆä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="content-wrapper">
    <section class="task-dashboard-header">
        <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    </section>

    <section class="task-dashboard-grid">
        <!-- å·¦ã‚«ãƒ©ãƒ  -->
        <div class="dashboard-column left-column">
            <!-- å€‹äººãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="dashboard-card performance-card">
                <h3>å€‹äººãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                <div class="performance-metrics">
                    <div class="metric-card">
                        <div class="metric-value">{{ dashboard_data.today_total }}</div>
                        <div class="metric-label">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</div>
                    </div>
                    <div class="metric-card completed">
                        <div class="metric-value">{{ dashboard_data.today_completed }}</div>
                        <div class="metric-label">å®Œäº†ã‚¿ã‚¹ã‚¯</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f"|format(dashboard_data.today_progress) }}%</div>
                        <div class="metric-label">å®Œäº†ç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ dashboard_data.consecutive_days }}æ—¥</div>
                        <div class="metric-label">é€£ç¶šé”æˆ</div>
                    </div>
                </div>
            </div>

            <!-- é€²æ—åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="dashboard-card progress-analysis-card">
                <h3>é€²æ—åˆ†æ</h3>
                
                <div class="progress-section">
                    <h4>æœ¬æ—¥ã®é€²æ—</h4>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: {{ dashboard_data.today_progress }}%"></div>
                    </div>
                    <div class="progress-text">{{ "%.1f"|format(dashboard_data.today_progress) }}% ({{ dashboard_data.today_completed }}/{{ dashboard_data.today_total }})</div>
                </div>

                <div class="task-summary">
                    <div class="summary-item completed">
                        <span class="summary-label">å®Œäº†æ¸ˆã¿</span>
                        <span class="summary-value">{{ dashboard_data.today_completed }}ä»¶</span>
                    </div>
                    <div class="summary-item remaining">
                        <span class="summary-label">æ®‹ã‚Š</span>
                        <span class="summary-value">{{ dashboard_data.today_remaining }}ä»¶</span>
                    </div>
                </div>

                <div class="chart-section">
                    <h4>éå»7æ—¥é–“ã®å®Œäº†ã‚¿ã‚¹ã‚¯æ•°</h4>
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ  -->
        <div class="dashboard-column right-column">
            <!-- ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="dashboard-card today-tasks-card">
                <div class="card-header">
                    <h3>ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ ({{ dashboard_data.today_total }}ä»¶)</h3>
                    <a href="/tasks" class="show-all-link">ã™ã¹ã¦è¡¨ç¤º</a>
                </div>
                <div class="tasks-list">
                    {% for task in today_tasks[:3] %}
                    <div class="task-item">
                        <div class="task-checkbox">
                            <input type="checkbox" {% if task.status == 'å®Œäº†' %}checked{% endif %} onchange="toggleTaskComplete({{ task.id }}, this.checked)">
                        </div>
                        <div class="task-content">
                            <div class="task-title">{{ task.title }}</div>
                            <div class="task-meta">
                                <span class="task-priority priority-{{ task.priority }}">{{ task.priority }}</span>
                                <span class="task-timer">00:00:00</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="task-arrow up" onclick="moveTaskUp({{ task.id }})">â†‘</button>
                            <button class="task-arrow down" onclick="moveTaskDown({{ task.id }})">â†“</button>
                        </div>
                    </div>
                    {% endfor %}
                    {% if today_tasks|length == 0 %}
                    <div class="no-tasks">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                    {% endif %}
                </div>
            </div>

            <!-- æ™‚é–“åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="dashboard-card time-analysis-card">
                <h3>æ™‚é–“åˆ†æ</h3>
                
                <div class="work-time-section">
                    <h4>æœ¬æ—¥ã®ç·ä½œæ¥­æ™‚é–“</h4>
                    <div class="work-time-display">
                        <span class="clock-icon">ğŸ•</span>
                        <span class="work-time-value">{{ dashboard_data.today_work_time }}</span>
                    </div>
                    <div class="work-time-label">æœ¬æ—¥ã®ç·ä½œæ¥­æ™‚é–“</div>
                </div>

                <div class="chart-section">
                    <h4>å„ªå…ˆåº¦åˆ¥ã‚¿ã‚¹ã‚¯æ•°</h4>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
function toggleTaskComplete(taskId, isComplete) {
    // ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹ã‚’æ›´æ–°
    fetch(`/api/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: isComplete ? 'å®Œäº†' : 'é€²è¡Œä¸­'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    });
}

function moveTaskUp(taskId) {
    // ã‚¿ã‚¹ã‚¯ã®é †åºã‚’ä¸Šã«ç§»å‹•
    console.log('Move task up:', taskId);
}

function moveTaskDown(taskId) {
    // ã‚¿ã‚¹ã‚¯ã®é †åºã‚’ä¸‹ã«ç§»å‹•
    console.log('Move task down:', taskId);
}
</script>

{% endblock %}

{% block extra_scripts %}
<script>
window.addEventListener('load', function() {
    // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }

    // éå»7æ—¥é–“ã®å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ã‚°ãƒ©ãƒ•
    const progressCtx = document.getElementById('progressChart');
    if (progressCtx) {
        const past7Days = {{ dashboard_data.past_7_days|tojson }};
        
        new Chart(progressCtx, {
            type: 'line',
            data: {
                labels: past7Days.map(d => d.date),
                datasets: [{
                    label: 'å®Œäº†ã‚¿ã‚¹ã‚¯æ•°',
                    data: past7Days.map(d => d.count),
                    borderColor: '#51cf66',
                    backgroundColor: 'rgba(81, 207, 102, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // å„ªå…ˆåº¦åˆ¥ã‚¿ã‚¹ã‚¯æ•°ã‚°ãƒ©ãƒ•
    const priorityCtx = document.getElementById('priorityChart');
    if (priorityCtx) {
        new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['é«˜', 'ä¸­', 'ä½'],
                datasets: [{
                    label: 'ã‚¿ã‚¹ã‚¯æ•°',
                    data: [
                        {{ dashboard_data.high_priority }},
                        {{ dashboard_data.medium_priority }},
                        {{ dashboard_data.low_priority }}
                    ],
                    backgroundColor: [
                        '#dc3545',
                        '#ffc107',
                        '#51cf66'
                    ],
                    borderColor: [
                        '#c82333',
                        '#e0a800',
                        '#2f9e44'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}

