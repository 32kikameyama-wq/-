# 動画編集案件管理Webアプリ 設計図 v1

作成日: 2025-11-04 / 作成目的: 動画編集会社向けの案件・素材・請求・収支・クライアント連携を一元管理するための仕様ドキュメント（コード無し）

---

## 0. スコープ（今回追加要件の反映）

* **素材保管（案件ごと）**: 素材の保管・版管理・権限管理・プレビュー・検索。
* **請求／収支（管理者限定）**: 売上・コスト・編集者支払・粗利の管理・分析ダッシュボード。
* **クライアント用ページ**: 完成動画の受け渡し、素材提供リンク（アップロード/URL）の受付、進捗の閲覧。
* **連携要件**: 編集者ページでアップロード→クライアントページにも自動反映。クライアントの素材提供→担当編集者へ自動通知/受け渡し。

---

## 1. システム概要

### 1.1 目的
動画編集会社向けの案件管理、素材管理、請求・収支管理、クライアント連携を一元管理するウェブアプリケーションです。

### 1.2 対象ユーザー
- **Admin（管理者）**: 全機能アクセス、請求・収支管理
- **Editor（編集者）**: 担当案件の編集・素材管理・進捗更新
- **Client（クライアント）**: 案件閲覧・完成物視聴・素材提供
- **Viewer（社内閲覧）**: 参照のみ（請求・収支ページは不可）

### 1.3 技術スタック
- **バックエンド**: Python 3.9+, Flask 3.0.0
- **フロントエンド**: HTML5, CSS3, JavaScript (ES6+)
- **データベース**: SQLite（初期）/ PostgreSQL（本番環境推奨）
- **ストレージ**: オブジェクトストレージ（S3互換推奨）
- **その他**: Flask-CORS, python-dotenv, JWT認証

---

## 2. ロールと権限

### 2.1 ロール定義

#### Admin（管理者）
- 全機能アクセス
- 請求・収支ページへのアクセス
- 単価設定・支払管理
- ユーザー管理
- ワークフロー編集
- ダウンロード権限

#### Editor（編集者）
- 自分に割り当てられた案件/タスクと素材の閲覧・アップロード
- 進捗更新
- 完成動画の登録
- クライアントの素材提供を受領

#### Client（クライアント）
- 自分の案件に限定した閲覧（進捗の概要、完成物ダウンロード/視聴）
- 素材提供（アップロード/URL登録）
- コメント/承認操作

#### Viewer（社内閲覧）
- 参照のみ
- 請求・収支ページは不可

### 2.2 権限の原則

すべてのリソースは `org_id` と `visibility_scope` を持つ。
- `Client` は自社プロジェクト配下の公開許可された情報にのみアクセス可能
- 請求・収支は `Admin` のみ
- 素材は `visibility_scope`（client/internal/private）で制御

---

## 3. 主要機能一覧

### 3.1 案件管理（ガント風）

- プロジェクト配下に LONG/SHORT の2軸で `VideoItem` を作成
- `Task`（編集/レビュー/サムネ/字幕/納品等）を管理
- ドラッグで日程調整
- 遅延ハイライト

### 3.2 素材管理（アセットライブラリ）

- **案件単位フォルダ / アイテム単位フォルダ**
- **ファイル版管理**（v1, v2…）
- **サムネ/低解像度プレビュー生成**
- **メタデータ**（解像度/コーデック/長さ/サイズ/タグ）付与
- **重複検知**（checksum）
- **検索**（タグ・拡張子・期間・担当）

**リンク運用（推奨）**:
- オブジェクトストレージ（例: S3互換）に実体保管
- アプリDBにメタ/URLを保存
- 外部Drive/YouTube/Frame.io等のURL登録も許容

**アクセス**:
- Editorは自身担当案件の素材にアップ/閲覧可
- Clientは「公開フラグ付き素材」のみ閲覧可

### 3.3 請求・収支管理（Adminのみ）

- **売上管理**: 見積/確定/入金
- **コスト管理**: 編集者への支払、外注、BGM/素材購入、ツール費等
- **自動原価集計**: 粗利/粗利率計算
- **分析**: 月次/案件別/クライアント別分析

**レート表**:
- 編集者ごとの単価（分単価/成果物単価/時給/出来高）
- 案件ごとの見積テンプレ

**書類生成**:
- 発注書/納品書/請求書PDF生成
- 支払予定表
- 入出金ステータス

### 3.4 クライアントページ

- **案件サマリ**: ステータス、主要マイルストーン、次のアクション
- **進捗ステータス**: 工程ステップの見える化（高粒度ではなく工程レベル）
- **完成物タブ**: 最新版の視聴/ダウンロード、旧版アクセス（任意）、承認/差戻し、コメントスレッド
- **素材提供フォーム**: アップロード or 外部リンク貼付。登録と同時に Editor に通知＋案件素材フォルダへ自動振り分け

### 3.5 通知/承認フロー

- **イベント駆動通知**:
  - アサイン、レビュー依頼、差戻し、期日超過
  - クライアント素材提供、承認完了、入金記録

- **承認ルール**: `APPROVED` 遷移には Reviewer=Admin/Leadの承認イベント必須

### 3.6 ダッシュボード/分析

- 今日の期限、遅延件数、今週納品予定
- リソース稼働
- 売上・粗利（Adminのみ）

---

## 4. 情報設計（エンティティ）

### 4.1 ER図（概念）

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│ Organization │       │     User     │       │   Project    │
│  (組織)      │       │   (ユーザー)  │       │   (案件)     │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id           │       │ id           │       │ id           │
│ name         │       │ name         │       │ name         │
│ domain       │       │ email        │       │ client_name  │
└──────────────┘       │ role         │       │ start_date   │
                       │ org_id       ├──────►│ due_date     │
                       │ active       │       │ status       │
                       └──────────────┘       │ owner_id     │
                                              │ org_id       │
┌──────────────┐       ┌──────────────┐       └──────┬───────┘
│  VideoItem   │       │     Task     │              │
│  (動画アイテム)│       │   (タスク)   │              │
├──────────────┤       ├──────────────┤              │
│ id           │       │ id           │              │
│ project_id   ├──────►│ item_id      ├──────────────┘
│ axis         │       │ type         │
│ (LONG|SHORT) │       │ (EDIT/REVIEW)│
│ title        │       │ status       │
│ status       │       │ assignee_id  │
│ assignee_id  │       │ planned_start│
│ planned_start│       │ planned_end  │
│ planned_end  │       │ progress_pct │
│ actual_start │       │ blocker_text │
│ actual_end   │       └──────────────┘
│ priority     │
│ tags[]       │
└──────┬───────┘
       │
       │
┌──────▼───────┐       ┌──────────────┐
│    Asset     │       │   Comment    │
│   (素材)     │       │  (コメント)   │
├──────────────┤       ├──────────────┤
│ id           │       │ id           │
│ project_id   │       │ target_type  │
│ item_id      │       │ target_id    │
│ kind         │       │ user_id      │
│ (raw|final)  │       │ body         │
│ storage      │       │ attachments[]│
│ (url)        │       │ visibility   │
│ checksum     │       └──────────────┘
│ bytes        │
│ duration     │       ┌──────────────┐
│ codec        │       │    Event     │
│ width/height │       │  (イベント)   │
│ version      │       ├──────────────┤
│ is_public    │       │ target_type  │
│ visibility   │       │ target_id    │
│ created_by   │       │ event_type   │
└──────────────┘       │ payload_json │
                       └──────────────┘

┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│   Estimate   │       │   Invoice    │       │   Payout     │
│   (見積)     │       │  (請求書)     │       │ (編集者支払) │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id           │       │ id           │       │ id           │
│ project_id   │       │ project_id   │       │ user_id      │
│ amount       │       │ amount       │       │ project_id   │
│ tax          │       │ tax          │       │ item_id      │
│ breakdown    │       │ invoice_no   │       │ basis        │
│ status       │       │ issue_date   │       │ (per_min...) │
└──────────────┘       │ due_date     │       │ unit_price   │
                       │ paid_date    │       │ qty          │
┌──────────────┐       │ status       │       │ amount       │
│    Cost      │       └──────────────┘       │ scheduled    │
│  (コスト)    │                              │ paid_date    │
├──────────────┤                              │ status       │
│ id           │                              └──────────────┘
│ project_id   │
│ category     │       ┌──────────────┐
│ amount       │       │   Revenue    │
│ note         │       │   (売上)     │
│ receipt_url  │       ├──────────────┤
└──────────────┘       │ id           │
                       │ project_id   │
                       │ item_id      │
                       │ amount       │
                       │ received_at  │
                       └──────────────┘
```

### 4.2 データベーススキーマ

#### 4.2.1 Organization（組織）
```sql
CREATE TABLE organizations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.2.2 User（ユーザー）
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'viewer',
    org_id INTEGER NOT NULL,
    active BOOLEAN DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (org_id) REFERENCES organizations(id)
);
```

#### 4.2.3 Project（案件）
```sql
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255) NOT NULL,
    client_name VARCHAR(255),
    start_date DATE,
    due_date DATE,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    owner_id INTEGER,
    org_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (owner_id) REFERENCES users(id),
    FOREIGN KEY (org_id) REFERENCES organizations(id)
);
```

#### 4.2.4 VideoItem（動画アイテム）
```sql
CREATE TABLE video_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    axis VARCHAR(10) NOT NULL CHECK (axis IN ('LONG', 'SHORT')),
    title VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    assignee_id INTEGER,
    planned_start DATE,
    planned_end DATE,
    actual_start DATE,
    actual_end DATE,
    priority VARCHAR(20) DEFAULT 'medium',
    tags TEXT, -- JSON array
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (assignee_id) REFERENCES users(id)
);
```

#### 4.2.5 Task（タスク）
```sql
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    item_id INTEGER NOT NULL,
    type VARCHAR(50) NOT NULL, -- EDIT, REVIEW, CAPTION, THUMB, UPLOAD, DELIVERY
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    assignee_id INTEGER,
    planned_start DATE,
    planned_end DATE,
    progress_pct INTEGER DEFAULT 0,
    blocker_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (item_id) REFERENCES video_items(id),
    FOREIGN KEY (assignee_id) REFERENCES users(id)
);
```

#### 4.2.6 Asset（素材）
```sql
CREATE TABLE assets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    item_id INTEGER,
    kind VARCHAR(50) NOT NULL, -- raw, music, image, subtitle, final, doc, other
    storage VARCHAR(500) NOT NULL, -- URL or path
    checksum VARCHAR(64),
    bytes BIGINT,
    duration INTEGER, -- seconds
    codec VARCHAR(50),
    width INTEGER,
    height INTEGER,
    created_by INTEGER,
    version INTEGER DEFAULT 1,
    is_public BOOLEAN DEFAULT 0,
    visibility_scope VARCHAR(20) DEFAULT 'internal', -- client, internal, private
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (item_id) REFERENCES video_items(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

#### 4.2.7 Comment（コメント）
```sql
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    target_type VARCHAR(50) NOT NULL, -- item, task, asset, project
    target_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    body TEXT NOT NULL,
    attachments TEXT, -- JSON array
    visibility_scope VARCHAR(20) DEFAULT 'internal', -- client, internal
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 4.2.8 Event（イベント）
```sql
CREATE TABLE events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    target_type VARCHAR(50) NOT NULL,
    target_id INTEGER NOT NULL,
    event_type VARCHAR(50) NOT NULL, -- ASSIGN, UPLOAD, REVIEW, APPROVE, REJECT, INVOICE, RECEIVE
    payload_json TEXT, -- JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.2.9 Estimate（見積）
```sql
CREATE TABLE estimates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    tax DECIMAL(10, 2) DEFAULT 0,
    breakdown_json TEXT, -- JSON
    status VARCHAR(50) DEFAULT 'draft', -- draft, sent, accepted
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

#### 4.2.10 Invoice（請求書）
```sql
CREATE TABLE invoices (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    tax DECIMAL(10, 2) DEFAULT 0,
    invoice_no VARCHAR(100) UNIQUE,
    issue_date DATE NOT NULL,
    due_date DATE NOT NULL,
    paid_date DATE,
    status VARCHAR(50) DEFAULT 'draft', -- draft, issued, paid, overdue
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

#### 4.2.11 Payout（編集者支払）
```sql
CREATE TABLE payouts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL, -- Editor
    project_id INTEGER NOT NULL,
    item_id INTEGER,
    basis VARCHAR(50) NOT NULL, -- per_min, per_item, per_hour, fixed
    unit_price DECIMAL(10, 2) NOT NULL,
    qty DECIMAL(10, 2) NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    scheduled_pay_date DATE,
    paid_date DATE,
    status VARCHAR(50) DEFAULT 'pending', -- pending, approved, paid
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (item_id) REFERENCES video_items(id)
);
```

#### 4.2.12 Cost（コスト）
```sql
CREATE TABLE costs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    category VARCHAR(50) NOT NULL, -- outsourcing, tool, music, stock, other
    amount DECIMAL(10, 2) NOT NULL,
    note TEXT,
    receipt_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

#### 4.2.13 Revenue（売上）
```sql
CREATE TABLE revenues (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    item_id INTEGER,
    amount DECIMAL(10, 2) NOT NULL,
    received_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (item_id) REFERENCES video_items(id)
);
```

#### 4.2.14 PortalAccess（ポータルアクセス）
```sql
CREATE TABLE portal_accesses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    token VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    expires_at TIMESTAMP,
    allow_download BOOLEAN DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

---

## 5. ワークフロー（主な流れ）

### 5.1 素材の取り込み

1. Admin/Editorが案件を作成し、`VideoItem(LONG/SHORT)` を登録
2. **素材アップロード**（Editor or Client）
   - Editor: 編集者ページからアップロード→`Asset(kind=raw)` で案件フォルダに保存
   - Client: クライアントページの素材提供フォーム→`Asset` レコードを生成し、Editorに通知。外部リンクの場合も `Asset.storage=url` で登録
3. 自動処理（非同期）
   - サムネ/低解像度プレビュー生成・メタ抽出・重複検知（checksum）

### 5.2 編集〜レビュー〜納品

1. Editorがタスク進捗更新。レビュー依頼でReviewerに通知
2. Reviewerが承認→`VideoItem.status=APPROVED`
3. Editorが**完成動画**を `Asset(kind=final, is_public=true, visibility_scope=client)` で登録
4. クライアントページに自動反映。クライアントが承認/差戻しを実施

### 5.3 請求・支払・分析

1. Adminが見積→請求書発行（PDF）→入金記録
2. 編集者への支払計算（レート表×出来高/分数/本数/時間）。`Payout` レコード作成
3. **収支自動計算**
   - 売上（入金確定）−（編集者支払＋その他コスト）= 粗利
   - ダッシュボードで案件別/期間別/クライアント別の粗利率を可視化

---

## 6. 画面構成

### 6.1 社内（Admin/Editor/Viewer）

#### ダッシュボード (`/`)
- KPI（案件数、遅延、今週納品、リソース稼働）
- Adminは売上/粗利カードも表示

#### ガント (`/gantt`)
- プロジェクト横断/単一表示
- LONG/SHORTトグル
- 担当/期間フィルタ
- ドラッグ編集

#### 案件詳細 (`/projects/:id`)
- 進捗ゲージ
- アイテム（LONG/SHORT）一覧
- 未解決ブロッカー
- 素材タブ
- コメント
- 履歴

#### 素材ライブラリ (`/assets`)
- 案件/種別/タグ/期間検索
- プレビュー
- バージョン
- 公開切替（client/internal）

#### マイタスク（編集者） (`/tasks`)
- 期日順リスト
- クイック進捗更新
- 関連素材のショートカット

#### 請求・収支（Admin） (`/finance`)
- 見積/請求書
- 入出金
- レート表
- Payout
- Cost
- 分析

### 6.2 クライアントページ（ポータル）

#### ログイン/共有リンク (`/portal/:token`)
- 案件別の共有リンク
- 有効期限/パスワード/ダウンロード可否を設定可能

#### 案件サマリ
- ステータス
- 主要マイルストーン
- 次のアクション

#### 完成物タブ
- 最新版の視聴/ダウンロード
- 旧版アクセス（任意）
- 承認/差戻し
- コメント

#### 素材提供タブ
- アップロード/リンク貼付
- 注意事項（著作権、容量、拡張子）
- 送信後、Editorに通知

---

## 7. 素材ストレージ設計

### 7.1 推奨構成

- **オブジェクトストレージ**（S3互換 or GCS互換）
  - バケット構成: `org_id/project_id/(assets|finals)/yyyy/mm/`
  - 権限制御: 署名付きURLで一時アクセス
  - `is_public` と `visibility_scope` で公開制御
  - 版管理: `asset_id/version/filename` で階層化。最新版フラグをDBで管理

### 7.2 ファイル種別

- raw（元素材）
- work（中間書き出し任意）
- final（納品）
- ref（参考素材）
- doc（台本/絵コンテ）

### 7.3 上限/運用

- 1ファイル上限、総量上限、保管期間（例: 90日後アーカイブ）を設定
- 自動クリーンアップジョブ

### 7.4 セキュリティ

- ウイルススキャン
- MIME検証
- 拡張子制限
- 透かし（final任意）

---

## 8. 請求・収支ロジック（要件）

### 8.1 レート表

**単価タイプ**:
- `per_min`（動画1分あたり）
- `per_item`（1本あたり）
- `per_hour`（時給）
- `fixed`（固定）

編集者ごとに既定レート＋案件上書き可

### 8.2 売上

見積→請求→入金。案件 or アイテム単位で計上。分割請求にも対応（例: 着手金/納品時）

### 8.3 編集者支払

実績（尺/本数/時間）×レートで自動計算、丸め/最低保証、承認フロー

### 8.4 粗利/粗利率

```
粗利 = 売上 − (編集者支払 + その他コスト)
粗利率 = 粗利 / 売上
```

### 8.5 分析ビュー

期間別、案件別、クライアント別、担当別、軸別（LONG/SHORT）

### 8.6 権限

全てAdmin限定表示。エクスポート（CSV/PDF）

---

## 9. 通知と自動化

### 9.1 通知チャンネル

- アプリ内
- メール
- （任意）Slack/Webhook

### 9.2 主なイベント

- アサイン
- レビュー依頼
- 差戻し
- クライアント素材提供
- 完成物公開
- 請求発行
- 入金記録
- 支払予定日

### 9.3 自動リマインド

- 期日-1日
- 未読コメント
- 未承認の完成物
- 未入金/未支払

---

## 10. セキュリティ/監査/法務

### 10.1 アクセス制御

- JWT（`org_id, role, user_id`）
- 行レベルで `org_id` を必須フィルタ
- Portalは共有トークン＋有効期限

### 10.2 監査ログ

重要操作（公開切替、請求発行、入出金記録、ダウンロード）を `Event` に記録。Portalダウンロードも記録

### 10.3 法務

- 著作権表示
- 利用規約
- 反社会的勢力排除
- 個人情報保護
- 二次利用可否の同意フラグ
- 素材提供時の同意チェック

---

## 11. 移行ポリシー（現行スプレッドシート → 本アプリ）

### 11.1 初期移行

CSVで `Project/VideoItem(Task含む)/Asset(リンクのみでも可)/Rate表/既存請求` を取り込み

### 11.2 運用移行

- 管理者は新規案件をアプリで作成
- 編集者はマイタスク＆素材アップロードへ移行
- クライアントへは案件単位のPortalリンクを配布

### 11.3 バックアップ

日次でメタCSV/JSON出力＋請求PDF/領収証のアーカイブ

---

## 12. 非機能要件

### 12.1 パフォーマンス

ガント表示は月間100案件/1,000アイテム/5,000タスク想定でも3秒以内表示（サーバ集計＋ページング）

### 12.2 可用性

99.5%目標。署名URLは短寿命（例: 10分）

### 12.3 拡張性

マルチテナント、外部ストレージ切替、SSO（将来）

### 12.4 コスト

ストレージ課金把握のため、案件ごと/クライアントごとに容量集計

---

## 13. MVP範囲（今回の最小構成）

1. ログイン/組織作成、ユーザー招待（Admin/Editor/Client）
2. Project/VideoItem/Task のCRUD＋ガント（読取＋ドラッグ更新）
3. 素材アップロード/リンク登録、プレビュー（静止画/低解像度生成）
4. クライアントページ（閲覧、完成物表示、素材提供フォーム、コメント）
5. 通知（アサイン、レビュー、完成物公開、素材提供）
6. 請求・収支（Adminのみの簡易版）：請求書作成、入金記録、編集者支払の自動計算（レート表＋出来高）と粗利表示
7. CSVインポート（案件/タスク/レート表/請求概要）

---

## 14. 画面遷移（シナリオ別）

### 14.1 Editor

ログイン → マイタスク → 案件詳細 → 素材アップ → レビュー依頼 → 完成物登録（公開ON）

### 14.2 Client

共有リンク → 案件サマリ → 完成物視聴 → 承認/差戻し → 素材提供

### 14.3 Admin

ダッシュボード → 請求作成 → 入金記録 → 支払計算 → 分析

---

## 15. 主要バリデーション/制約

- `Asset(kind=final)` で `visibility_scope=client` に設定されているもののみクライアント表示
- `Invoice.status=paid` には `paid_date` 必須。`overdue` は `due_date < today && paid_date is null`
- `Payout` の計算根拠（qty/単価/タイプ）は履歴として固定化（再計算で過去が変わらないように）
- Portal共有リンクは案件単位。無効化/再発行可。ダウンロード可否フラグ

---

## 16. レポート定義（初期）

### 16.1 案件別収支表

売上/入金、コスト（編集者支払/外注/ツール）、粗利、粗利率

### 16.2 クライアント別サマリ

案件数、総売上、平均粗利率、平均納期、遅延率

### 16.3 編集者別稼働/支払

担当本数/尺/時間、支払額、平均単価、納期遵守率

### 16.4 素材容量ランキング

プロジェクト/クライアント別の使用量

---

## 17. 既知のリスクと回避策

### 17.1 大容量アップロード

レジューム/分割アップロードを採用。クライアント側にもドラッグ&ドロップ＋進捗表示

### 17.2 著作権/二次利用

素材提供時の同意チェック、社内レビューで公開可否を二重承認

### 17.3 コスト肥大

アーカイブ/自動削除ポリシー、サムネ/プロキシ生成で閲覧は軽量化

### 17.4 人的エラー

公開切替時の確認ダイアログ、Portalの閲覧範囲は案件固定

---

## 18. 今後の発展（MVP後）

- Frame.ioやYouTube APIとの連携（コメント同期/公開予約）
- 自動音声起こし/尺抽出/自動サムネ候補生成
- タイムライン内コメント（TC付き）、差分比較
- 原価の自動推定（AIで工数推定→見積ナッジ）
- SSO/SAML、監査レポートの外部出力

---

## 19. API設計

### 19.1 RESTful API エンドポイント

#### 案件関連API
```
GET    /api/projects                    # 案件一覧取得
GET    /api/projects/:id                 # 案件詳細取得
POST   /api/projects                    # 案件作成
PUT    /api/projects/:id                # 案件更新
DELETE /api/projects/:id                # 案件削除
GET    /api/projects/:id/items           # アイテム一覧取得
GET    /api/projects/:id/tasks           # タスク一覧取得
```

#### アイテム関連API
```
GET    /api/items                       # アイテム一覧取得
GET    /api/items/:id                   # アイテム詳細取得
POST   /api/items                       # アイテム作成
PUT    /api/items/:id                   # アイテム更新
DELETE /api/items/:id                   # アイテム削除
GET    /api/items/:id/tasks             # アイテムのタスク一覧
```

#### タスク関連API
```
GET    /api/tasks                       # タスク一覧取得
GET    /api/tasks/:id                   # タスク詳細取得
POST   /api/tasks                       # タスク作成
PUT    /api/tasks/:id                   # タスク更新
DELETE /api/tasks/:id                   # タスク削除
PUT    /api/tasks/:id/progress          # 進捗更新
```

#### 素材関連API
```
GET    /api/assets                      # 素材一覧取得（検索・フィルタ）
GET    /api/assets/:id                  # 素材詳細取得
POST   /api/assets                      # 素材アップロード
PUT    /api/assets/:id                  # 素材更新
DELETE /api/assets/:id                  # 素材削除
GET    /api/assets/:id/preview          # プレビュー取得
GET    /api/assets/:id/download        # ダウンロードURL取得（署名付き）
POST   /api/assets/:id/version          # 新バージョン作成
PUT    /api/assets/:id/visibility       # 公開設定変更
```

#### 請求・収支関連API（Adminのみ）
```
GET    /api/finance/estimates           # 見積一覧
POST   /api/finance/estimates           # 見積作成
GET    /api/finance/invoices            # 請求書一覧
POST   /api/finance/invoices            # 請求書作成
PUT    /api/finance/invoices/:id/paid   # 入金記録
GET    /api/finance/payouts             # 支払一覧
POST   /api/finance/payouts             # 支払作成
GET    /api/finance/costs               # コスト一覧
POST   /api/finance/costs               # コスト登録
GET    /api/finance/revenues            # 売上一覧
GET    /api/finance/analysis            # 分析データ取得
GET    /api/finance/rate-table          # レート表取得
PUT    /api/finance/rate-table          # レート表更新
```

#### クライアントポータルAPI
```
GET    /api/portal/:token/project       # 案件情報取得
GET    /api/portal/:token/assets        # 公開素材一覧
GET    /api/portal/:token/finals        # 完成物一覧
POST   /api/portal/:token/assets        # 素材提供
POST   /api/portal/:token/approve       # 承認
POST   /api/portal/:token/reject        # 差戻し
POST   /api/portal/:token/comments      # コメント投稿
```

#### ダッシュボードAPI
```
GET    /api/dashboard/stats             # 統計情報取得
GET    /api/dashboard/recent            # 最近の活動取得
GET    /api/dashboard/gantt            # ガントデータ取得
```

### 19.2 レスポンス形式

#### 成功レスポンス
```json
{
    "status": "success",
    "data": { ... },
    "message": "操作が成功しました"
}
```

#### エラーレスポンス
```json
{
    "status": "error",
    "error": {
        "code": "ERROR_CODE",
        "message": "エラーメッセージ"
    }
}
```

---

## 20. システムアーキテクチャ

### 20.1 全体構成図

```
┌─────────────────────────────────────────────────┐
│              クライアント（ブラウザ）              │
│  HTML + CSS + JavaScript                        │
│  - 社内ダッシュボード                            │
│  - クライアントポータル                          │
└──────────────────┬──────────────────────────────┘
                   │ HTTP/HTTPS
                   │ JSON API
┌──────────────────▼──────────────────────────────┐
│              Flask アプリケーション               │
│  ┌──────────────┐  ┌──────────────┐            │
│  │ ルーティング  │  │ ビジネスロジック│            │
│  │ (REST API)   │  │ (Services)   │            │
│  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐  ┌──────────────┐            │
│  │ データアクセス│  │ 認証・認可    │            │
│  │ (Models/ORM) │  │ (JWT/Auth)   │            │
│  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐                              │
│  │ 通知サービス  │                              │
│  │ (Email/Event)│                              │
│  └──────────────┘                              │
└──────┬──────────────────┬──────────────────────┘
       │                  │
       │                  │
┌──────▼──────┐  ┌───────▼────────┐
│ データベース  │  │ オブジェクトストレージ│
│ SQLite/PostgreSQL │ │ S3/GCS互換      │
└─────────────┘  └─────────────────┘
```

### 20.2 ディレクトリ構造

```
案件管理システム/
├── app.py                    # Flaskアプリケーション本体
├── config.py                 # 設定ファイル
├── requirements.txt          # 依存パッケージ
├── .env                      # 環境変数
├── .gitignore
├── README.md
├── 設計書_初稿.md
├── templates/                 # HTMLテンプレート
│   ├── layout.html           # 共通レイアウト
│   ├── index.html            # ダッシュボード
│   ├── projects/             # 案件関連
│   │   ├── list.html
│   │   ├── detail.html
│   │   └── create.html
│   ├── items/                # アイテム関連
│   ├── tasks/                # タスク管理
│   ├── assets/               # 素材ライブラリ
│   ├── finance/              # 請求・収支（Adminのみ）
│   ├── portal/               # クライアントポータル
│   │   ├── login.html
│   │   ├── project.html
│   │   └── upload.html
│   └── auth/                 # 認証関連
│       ├── login.html
│       └── register.html
├── static/                   # 静的ファイル
│   ├── css/
│   │   ├── style.css
│   │   ├── components.css
│   │   └── gantt.css
│   ├── js/
│   │   ├── main.js
│   │   ├── api.js
│   │   ├── gantt.js
│   │   ├── upload.js
│   │   └── utils.js
│   └── images/
├── models/                   # データモデル
│   ├── __init__.py
│   ├── organization.py
│   ├── user.py
│   ├── project.py
│   ├── video_item.py
│   ├── task.py
│   ├── asset.py
│   ├── comment.py
│   ├── event.py
│   ├── estimate.py
│   ├── invoice.py
│   ├── payout.py
│   ├── cost.py
│   ├── revenue.py
│   └── portal_access.py
├── routes/                   # ルーティング
│   ├── __init__.py
│   ├── auth.py              # 認証
│   ├── projects.py          # 案件
│   ├── items.py             # アイテム
│   ├── tasks.py             # タスク
│   ├── assets.py            # 素材
│   ├── finance.py           # 請求・収支
│   ├── portal.py            # クライアントポータル
│   └── api.py               # API
├── services/                # ビジネスロジック
│   ├── __init__.py
│   ├── project_service.py
│   ├── asset_service.py
│   ├── finance_service.py
│   ├── notification_service.py
│   └── storage_service.py
├── database/                # データベース関連
│   ├── __init__.py
│   ├── db.py                # DB接続
│   └── migrations/          # マイグレーション
└── utils/                   # ユーティリティ
    ├── __init__.py
    ├── auth.py              # 認証ヘルパー
    ├── permissions.py       # 権限チェック
    └── validators.py        # バリデーション
```

---

## 21. 開発フェーズ

### フェーズ1: 基本機能実装（MVP）
- ✅ プロジェクト環境構築
- ✅ 基本構造の作成
- ⏳ データベース設計・実装
- ⏳ 認証・認可システム
- ⏳ 案件管理機能（Project/VideoItem/Task）
- ⏳ ガント表示
- ⏳ 素材管理機能（アップロード/プレビュー）
- ⏳ クライアントポータル
- ⏳ 通知機能
- ⏳ 請求・収支管理（簡易版）

### フェーズ2: 機能強化
- 素材版管理
- 請求書PDF生成
- レート表管理
- 分析ダッシュボード
- CSVインポート

### フェーズ3: UI/UX改善
- レスポンシブデザイン
- アニメーション・インタラクション
- ドラッグ&ドロップ
- 進捗表示の改善

### フェーズ4: 最適化・テスト
- パフォーマンス最適化
- ユニットテスト
- 統合テスト
- セキュリティ監査

---

## 22. 付録

### 付録A: 役割×ページ権限マトリクス

| ページ | Admin | Editor | Viewer | Client |
|--------|-------|--------|--------|--------|
| ダッシュボード | 閲覧・編集 | 閲覧 | 閲覧 | 非表示 |
| ガント | 閲覧・編集 | 閲覧・編集（担当のみ） | 閲覧 | 非表示 |
| 案件詳細 | 閲覧・編集 | 閲覧・編集（担当のみ） | 閲覧 | 公開スコープのみ閲覧 |
| 素材 | 閲覧・編集 | 閲覧・編集（担当のみ） | 閲覧 | 公開素材のみ閲覧/提供 |
| 請求/収支 | 閲覧・編集 | 非表示 | 非表示 | 非表示 |
| クライアントページ | 非表示 | 非表示 | 非表示 | 閲覧・操作 |

### 付録B: 通知テンプレ（例）

- 「新しい素材がクライアントから提供されました（案件: X / アイテム: Y）」
- 「レビュー依頼: アイテムY」
- 「完成物が公開されました（案件: X）」
- 「請求No.1234 を発行しました」
- 「本日支払予定のPayoutがN件あります」

---

## 23. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2025-11-04 | 1.0 | 初稿作成（動画編集案件管理要件反映） | - |

---

**備考**: この設計書は初稿です。開発を進めながら内容を更新・改善していきます。
